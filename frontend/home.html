<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Notes - Student Notes Portal</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <a href="home.html" class="navbar-brand">
                <i class="fa-solid fa-book-open"></i>
                <span>TrackNotes</span>
            </a>
            <ul class="navbar-nav">
                <li><a href="home.html" class="active">My Notes</a></li>
            </ul>
            <div class="user-menu">
                <div class="user-avatar" id="userAvatar">U</div>
                <button class="btn btn-secondary btn-sm" id="logoutBtn">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="dashboard">
        <div class="container">
            <!-- Dashboard Header -->
            <div class="dashboard-header">
                <div>
                    <h1>My Notes</h1>
                    <p class="welcome-text">Welcome back, <span id="usernameDisplay">Student</span>!</p>
                </div>
                <button class="btn btn-primary" id="newNoteBtn">
                    <i class="fa-solid fa-plus"></i> New Note
                </button>
            </div>

            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon notes"><i class="fa-solid fa-note-sticky"></i></div>
                    <div class="stat-info">
                        <h3 id="totalNotes">0</h3>
                        <p>Total Notes</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon recent"><i class="fa-solid fa-clock"></i></div>
                    <div class="stat-info">
                        <h3 id="recentNotes">0</h3>
                        <p>Added This Week</p>
                    </div>
                </div>
            </div>

            <!-- Search Bar -->
            <div class="notes-section">
                <div class="notes-header">
                    <h2>All Notes</h2>
                    <div class="search-bar">
                        <i class="fa-solid fa-magnifying-glass search-icon"></i>
                        <input type="text" id="searchInput" placeholder="Search notes...">
                    </div>
                </div>

                <!-- Notes Grid -->
                <div class="notes-grid" id="notesGrid">
                    <!-- Notes will be dynamically loaded here -->
                </div>

                <!-- Empty State -->
                <div class="empty-state" id="emptyState">
                    <div class="empty-state-icon"><i class="fa-solid fa-file-circle-plus"></i></div>
                    <h3>No notes yet</h3>
                    <p>Start by creating your first note to organize your study materials.</p>
                    <button class="btn btn-primary" id="emptyNewNoteBtn">Create Your First Note</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Create/Edit Note Modal -->
    <div class="modal-overlay" id="noteModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modalTitle">Create New Note</h2>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="noteForm">
                    <input type="hidden" id="noteId">
                    <div class="form-group">
                        <label for="noteTitle" class="form-label">Title</label>
                        <input 
                            type="text" 
                            id="noteTitle" 
                            class="form-input" 
                            placeholder="Enter note title"
                            required
                            maxlength="100"
                        >
                    </div>
                    <div class="form-group">
                        <label for="noteContent" class="form-label">Content</label>
                        <textarea 
                            id="noteContent" 
                            class="form-textarea" 
                            placeholder="Write your note content here..."
                            required
                        ></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelBtn">Cancel</button>
                <button class="btn btn-primary" id="saveNoteBtn">Save Note</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Delete Note</h2>
                <button class="modal-close" id="closeDeleteModal">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this note? This action cannot be undone.</p>
                <input type="hidden" id="deleteNoteId">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelDeleteBtn">Cancel</button>
                <button class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>

    <script>
        // Check authentication
        const token = localStorage.getItem('token');
        const username = localStorage.getItem('username');

        if (!token) {
            window.location.href = 'login.html';
        }

        // Set username display
        document.getElementById('usernameDisplay').textContent = username || 'Student';
        document.getElementById('userAvatar').textContent = username ? username.charAt(0).toUpperCase() : 'U';

        // DOM Elements
        const notesGrid = document.getElementById('notesGrid');
        const emptyState = document.getElementById('emptyState');
        const noteModal = document.getElementById('noteModal');
        const deleteModal = document.getElementById('deleteModal');
        const noteForm = document.getElementById('noteForm');
        const searchInput = document.getElementById('searchInput');

        // Notes data
        let notes = [];

        // Check if demo mode
        const isDemoMode = localStorage.getItem('demoMode') === 'true';

        // Demo notes for testing
        const DEMO_NOTES = [
            { _id: '1', title: 'Math Notes - Calculus', content: 'Integration formulas: âˆ«x^n dx = x^(n+1)/(n+1) + C. Remember the chain rule for derivatives. The fundamental theorem connects differentiation and integration.', createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() },
            { _id: '2', title: 'History Essay Outline', content: 'Topic: Industrial Revolution. Key points: 1) Origins in Britain 2) Technological innovations 3) Social impact on working class 4) Urbanization effects', createdAt: new Date(Date.now() - 86400000).toISOString(), updatedAt: new Date(Date.now() - 86400000).toISOString() },
            { _id: '3', title: 'Chemistry Lab Report', content: 'Experiment: Titration of HCl with NaOH. Objective: Determine the concentration of unknown acid solution. Equipment: burette, pipette, conical flask.', createdAt: new Date(Date.now() - 172800000).toISOString(), updatedAt: new Date(Date.now() - 172800000).toISOString() },
            { _id: '4', title: 'Physics - Quantum Mechanics', content: 'Wave-particle duality: Light exhibits both wave and particle properties. Heisenberg uncertainty principle limits precision of measurements.', createdAt: new Date(Date.now() - 432000000).toISOString(), updatedAt: new Date(Date.now() - 432000000).toISOString() }
        ];

        // Load notes on page load
        loadNotes();

        // Event Listeners
        document.getElementById('newNoteBtn').addEventListener('click', () => openNoteModal());
        document.getElementById('emptyNewNoteBtn').addEventListener('click', () => openNoteModal());
        document.getElementById('closeModal').addEventListener('click', () => closeNoteModal());
        document.getElementById('cancelBtn').addEventListener('click', () => closeNoteModal());
        document.getElementById('saveNoteBtn').addEventListener('click', () => saveNote());
        document.getElementById('closeDeleteModal').addEventListener('click', () => closeDeleteModal());
        document.getElementById('cancelDeleteBtn').addEventListener('click', () => closeDeleteModal());
        document.getElementById('confirmDeleteBtn').addEventListener('click', () => deleteNote());
        document.getElementById('logoutBtn').addEventListener('click', () => logout());
        searchInput.addEventListener('input', (e) => filterNotes(e.target.value));

        // Close modal when clicking outside
        noteModal.addEventListener('click', (e) => {
            if (e.target === noteModal) closeNoteModal();
        });
        deleteModal.addEventListener('click', (e) => {
            if (e.target === deleteModal) closeDeleteModal();
        });

        // Functions
        async function loadNotes() {
            // Demo mode - use mock data
            if (isDemoMode) {
                notes = [...DEMO_NOTES];
                renderNotes(notes);
                updateStats();
                return;
            }

            try {
                const response = await fetch('/api/notes', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    notes = await response.json();
                    renderNotes(notes);
                    updateStats();
                } else if (response.status === 401) {
                    logout();
                }
            } catch (error) {
                console.error('Error loading notes:', error);
            }
        }

        function renderNotes(notesToRender) {
            if (notesToRender.length === 0) {
                notesGrid.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            notesGrid.style.display = 'grid';
            emptyState.style.display = 'none';

            notesGrid.innerHTML = notesToRender.map(note => `
                <div class="note-card" data-id="${note._id}">
                    <div class="note-card-body">
                        <h3>${escapeHtml(note.title)}</h3>
                        <p>${escapeHtml(note.content)}</p>
                    </div>
                    <div class="note-card-footer">
                        <span class="note-date">${formatDate(note.updatedAt || note.createdAt)}</span>
                        <div class="note-actions">
                            <button class="btn-edit" onclick="openEditModal('${note._id}')">Edit</button>
                            <button class="btn-delete" onclick="openDeleteModal('${note._id}')">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateStats() {
            document.getElementById('totalNotes').textContent = notes.length;
            
            // Count notes from this week
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            const recentCount = notes.filter(note => new Date(note.createdAt) > oneWeekAgo).length;
            document.getElementById('recentNotes').textContent = recentCount;
        }

        function filterNotes(query) {
            const filtered = notes.filter(note => 
                note.title.toLowerCase().includes(query.toLowerCase()) ||
                note.content.toLowerCase().includes(query.toLowerCase())
            );
            renderNotes(filtered);
        }

        function openNoteModal(noteId = null) {
            document.getElementById('modalTitle').textContent = noteId ? 'Edit Note' : 'Create New Note';
            document.getElementById('noteId').value = noteId || '';
            
            if (noteId) {
                const note = notes.find(n => n._id === noteId);
                if (note) {
                    document.getElementById('noteTitle').value = note.title;
                    document.getElementById('noteContent').value = note.content;
                }
            } else {
                noteForm.reset();
            }
            
            noteModal.classList.add('active');
        }

        function closeNoteModal() {
            noteModal.classList.remove('active');
            noteForm.reset();
        }

        function openEditModal(noteId) {
            openNoteModal(noteId);
        }

        function openDeleteModal(noteId) {
            document.getElementById('deleteNoteId').value = noteId;
            deleteModal.classList.add('active');
        }

        function closeDeleteModal() {
            deleteModal.classList.remove('active');
        }

        async function saveNote() {
            const noteId = document.getElementById('noteId').value;
            const title = document.getElementById('noteTitle').value;
            const content = document.getElementById('noteContent').value;

            if (!title || !content) {
                alert('Please fill in all fields');
                return;
            }

            const url = noteId ? `/api/notes/${noteId}` : '/api/notes';
            const method = noteId ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ title, content })
                });

                if (response.ok) {
                    closeNoteModal();
                    loadNotes();
                } else {
                    const data = await response.json();
                    alert(data.message || 'Failed to save note');
                }
            } catch (error) {
                console.error('Error saving note:', error);
                alert('An error occurred. Please try again.');
            }
        }

        async function deleteNote() {
            const noteId = document.getElementById('deleteNoteId').value;

            try {
                const response = await fetch(`/api/notes/${noteId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    closeDeleteModal();
                    loadNotes();
                } else {
                    const data = await response.json();
                    alert(data.message || 'Failed to delete note');
                }
            } catch (error) {
                console.error('Error deleting note:', error);
                alert('An error occurred. Please try again.');
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            window.location.href = 'login.html';
        }

        // Utility functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric',
                year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
            });
        }
    </script>
</body>
</html>